<?php
if (session_status() !== PHP_SESSION_ACTIVE) {
    session_start();
}

$SUPPORTED_LANGS = ["zh", "en"];

if (isset($_GET["lang"]) && in_array($_GET["lang"], $SUPPORTED_LANGS, true)) {
    $_SESSION["lang"] = $_GET["lang"];
}

function current_lang()
{
    $lang = $_SESSION["lang"] ?? "zh";
    return in_array($lang, ["zh", "en"], true) ? $lang : "zh";
}

function language_switch_url($lang)
{
    $base = strtok($_SERVER["REQUEST_URI"], "?");
    return $base . "?lang=" . $lang;
}

$TRANSLATIONS = [
    "zh" => [
        "system_name" => "药品管理系统",
        "login_title" => "系统登录",
        "login" => "登录",
        "username" => "用户名",
        "password" => "密码",
        "remember_me" => "保持登录（7天）",
        "logout" => "退出",
        "dashboard_title" => "首页面板",
        "select_feature" => "请选择需要使用的功能",
        "stock_list" => "库存列表",
        "add_stock" => "添加库存",
        "batch_list" => "批次列表",
        "batch_number" => "批号",
        "expire_date" => "有效期",
        "days_left" => "剩余天数",
        "days" => "天",
        "add_batch" => "添加批次",
        "drug_list" => "药品列表",
        "add_drug" => "添加药品",
        "location_list" => "位置列表",
        "add_location" => "添加位置",
        "notice_center" => "药品提醒中心",
        "drug_name" => "药品名称",
        "location_name" => "存放位置",
        "quantity" => "数量",
        "unit" => "单位",
        "min_quantity" => "下限",
        "updated_at" => "最后更新",
        "actions" => "操作",
        "not_set" => "未设置",
        "low" => "不足",
        "return" => "返回",
        "edit" => "编辑",
        "delete" => "删除",
        "no_permission" => "无权限",
        "no_permission_access" => "无权限访问该功能。",
        "confirm_delete_stock" => "确认删除该库存记录？",
        "confirm_delete_batch" => "确定删除该批次？",
        "confirm_delete_drug" => "确认删除该药品吗？",
        "confirm_delete_location" => "确定删除该位置？",
        "stock_recalc" => "重新计算库存",
        "stock_recalc_done" => "库存已根据批次数据重新计算并更新！",
        "stock_deleted" => "库存记录已删除。",
        "batch_deleted" => "批次记录已删除（已同步更新库存）。",
        "drug_deleted" => "药品已成功删除。",
        "location_deleted" => "位置已删除。",
        "location_in_use" => "该位置正在被使用，无法删除。",
        "location_updated" => "位置已更新。",
        "batch_deleted_notice" => "批次已删除。",
        "no_stock_records" => "暂无库存记录。",
        "no_batch_records" => "暂无批次记录。",
        "no_drug_records" => "暂无药品，请添加。",
        "expired" => "已过期",
        "expiring_soon" => "临期",
        "notice_title" => "需要注意的药品提醒",
        "notice_batch_title" => "临期 / 过期 批次",
        "notice_stock_title" => "库存不足药品",
        "current_stock" => "当前库存",
        "notice_no_batch" => "目前没有临期或过期批次。",
        "notice_no_stock" => "目前没有库存不足的药品。",
        "only_left" => "仅剩 %d 天",
        "add" => "添加",
        "save" => "保存",
        "update" => "更新",
        "submit" => "提交",
        "select_drug" => "请选择药品",
        "select_location" => "请选择位置",
        "drug_label" => "药品 *",
        "location_label" => "存放位置 *",
        "quantity_label" => "数量 *",
        "unit_label" => "单位（如：盒 / 瓶 / 支）",
        "min_quantity_hint" => "库存下限（低于此数量时提醒）",
        "stock_add_success" => "库存添加成功！",
        "add_failed" => "添加失败：%s",
        "stock_list_title" => "库存列表",
        "batch_list_title" => "批次列表（有效期管理）",
        "drug_list_title" => "药品列表",
        "drug_type" => "剂型",
        "drug_spec" => "规格",
        "storage_requirement" => "保存要求",
        "remark" => "备注",
        "created_at" => "添加时间",
        "location_list_title" => "存放位置列表",
        "location_name_label" => "位置名称",
        "description" => "描述",
        "add_stock_title" => "添加库存",
        "add_batch_title" => "添加批次",
        "batch_add_success" => "批次添加成功！",
        "batch_number_optional" => "批号（可选）",
        "expire_date_label" => "有效期 *",
        "search_drug_placeholder" => "搜索药品名称…",
        "add_drug_title" => "添加药品",
        "drug_add_success" => "药品已成功添加！",
        "drug_name_label" => "药品名称 *",
        "drug_type_hint" => "剂型（注射剂 / 片剂 / 胶囊剂等）",
        "drug_spec_hint" => "规格（如：0.5g*10片/盒）",
        "storage_requirement_hint" => "保存要求（如：避光、2-8°C、冷藏）",
        "remark_optional" => "备注（可选）",
        "add_location_title" => "添加位置",
        "location_add_title" => "添加存放位置",
        "location_name_required" => "位置名称不能为空。",
        "location_name_placeholder" => "例如：A区-抽屉1、柜子上层、袋子3号",
        "description_optional" => "描述（可选）",
        "description_placeholder" => "例如：阴凉干燥，避光保存，常用药分区",
        "edit_stock_title" => "编辑库存",
        "missing_stock_id" => "缺少库存 ID",
        "stock_not_found" => "未找到库存记录。",
        "current_quantity" => "当前数量",
        "min_quantity_label" => "提醒下限 *",
        "unit_required" => "单位 *",
        "select_location_placeholder" => "请选择...",
        "save_changes" => "保存修改",
        "update_failed" => "更新失败：%s",
        "edit_stock_heading" => "编辑库存：%s",
        "edit_batch_title" => "编辑批次",
        "missing_batch_id" => "缺少批次 ID",
        "batch_not_found" => "未找到该批次记录",
        "edit_batch_heading" => "编辑批次：%s",
        "edit_drug_title" => "编辑药品",
        "missing_drug_id" => "缺少药品 ID",
        "drug_not_found" => "找不到该药品",
        "edit_drug_heading" => "编辑药品：%s",
        "edit_location_title" => "编辑位置",
        "missing_location_id" => "缺少位置 ID",
        "location_not_found" => "找不到该位置",
        "edit_location_heading" => "编辑存放位置：%s",
        "language_zh" => "中文",
        "language_en" => "English",
        "login_error" => "用户名或密码错误。",
    ],
    "en" => [
        "system_name" => "Medicine Management System",
        "login_title" => "System Login",
        "login" => "Log In",
        "username" => "Username",
        "password" => "Password",
        "remember_me" => "Stay logged in (7 days)",
        "logout" => "Log Out",
        "dashboard_title" => "Dashboard",
        "select_feature" => "Please choose a feature",
        "stock_list" => "Stock List",
        "add_stock" => "Add Stock",
        "batch_list" => "Batch List",
        "batch_number" => "Batch No.",
        "expire_date" => "Expiry Date",
        "days_left" => "Days Left",
        "days" => "days",
        "add_batch" => "Add Batch",
        "drug_list" => "Drug List",
        "add_drug" => "Add Drug",
        "location_list" => "Location List",
        "add_location" => "Add Location",
        "notice_center" => "Alert Center",
        "drug_name" => "Drug Name",
        "location_name" => "Location",
        "quantity" => "Quantity",
        "unit" => "Unit",
        "min_quantity" => "Minimum",
        "updated_at" => "Last Updated",
        "actions" => "Actions",
        "not_set" => "Not set",
        "low" => "Low",
        "return" => "Back",
        "edit" => "Edit",
        "delete" => "Delete",
        "no_permission" => "No access",
        "no_permission_access" => "You do not have permission to access this feature.",
        "confirm_delete_stock" => "Delete this stock record?",
        "confirm_delete_batch" => "Delete this batch?",
        "confirm_delete_drug" => "Delete this drug?",
        "confirm_delete_location" => "Delete this location?",
        "stock_recalc" => "Recalculate Stock",
        "stock_recalc_done" => "Stock has been recalculated from batch data.",
        "stock_deleted" => "Stock record deleted.",
        "batch_deleted" => "Batch deleted (stock updated).",
        "drug_deleted" => "Drug deleted.",
        "location_deleted" => "Location deleted.",
        "location_in_use" => "This location is in use and cannot be deleted.",
        "location_updated" => "Location updated.",
        "batch_deleted_notice" => "Batch deleted.",
        "no_stock_records" => "No stock records.",
        "no_batch_records" => "No batches found.",
        "no_drug_records" => "No drugs found. Please add one.",
        "expired" => "Expired",
        "expiring_soon" => "Expiring",
        "notice_title" => "Alerts to Review",
        "notice_batch_title" => "Expiring / Expired Batches",
        "notice_stock_title" => "Low Stock Items",
        "current_stock" => "Current Stock",
        "notice_no_batch" => "No expiring or expired batches.",
        "notice_no_stock" => "No low stock items.",
        "only_left" => "Only %d days left",
        "add" => "Add",
        "save" => "Save",
        "update" => "Update",
        "submit" => "Submit",
        "select_drug" => "Select a drug",
        "select_location" => "Select a location",
        "drug_label" => "Drug *",
        "location_label" => "Location *",
        "quantity_label" => "Quantity *",
        "unit_label" => "Unit (e.g. box / bottle / vial)",
        "min_quantity_hint" => "Minimum quantity (alert below this)",
        "stock_add_success" => "Stock added successfully!",
        "add_failed" => "Add failed: %s",
        "stock_list_title" => "Stock List",
        "batch_list_title" => "Batch List (Expiry)",
        "drug_list_title" => "Drug List",
        "drug_type" => "Form",
        "drug_spec" => "Specification",
        "storage_requirement" => "Storage",
        "remark" => "Notes",
        "created_at" => "Created At",
        "location_list_title" => "Location List",
        "location_name_label" => "Location Name",
        "description" => "Description",
        "add_stock_title" => "Add Stock",
        "add_batch_title" => "Add Batch",
        "batch_add_success" => "Batch added successfully!",
        "batch_number_optional" => "Batch No. (optional)",
        "expire_date_label" => "Expiry Date *",
        "search_drug_placeholder" => "Search drug name…",
        "add_drug_title" => "Add Drug",
        "drug_add_success" => "Drug added successfully!",
        "drug_name_label" => "Drug Name *",
        "drug_type_hint" => "Form (injection / tablet / capsule, etc.)",
        "drug_spec_hint" => "Specification (e.g. 0.5g*10 tablets/box)",
        "storage_requirement_hint" => "Storage (e.g. keep away from light, 2-8°C, refrigerated)",
        "remark_optional" => "Notes (optional)",
        "add_location_title" => "Add Location",
        "location_add_title" => "Add Storage Location",
        "location_name_required" => "Location name is required.",
        "location_name_placeholder" => "e.g. Area A - Drawer 1, top shelf, bag 3",
        "description_optional" => "Description (optional)",
        "description_placeholder" => "e.g. cool and dry, away from light, common meds",
        "edit_stock_title" => "Edit Stock",
        "missing_stock_id" => "Missing stock ID",
        "stock_not_found" => "Stock record not found.",
        "current_quantity" => "Current Quantity",
        "min_quantity_label" => "Minimum Alert *",
        "unit_required" => "Unit *",
        "select_location_placeholder" => "Select...",
        "save_changes" => "Save Changes",
        "update_failed" => "Update failed: %s",
        "edit_stock_heading" => "Edit Stock: %s",
        "edit_batch_title" => "Edit Batch",
        "missing_batch_id" => "Missing batch ID",
        "batch_not_found" => "Batch record not found",
        "edit_batch_heading" => "Edit Batch: %s",
        "edit_drug_title" => "Edit Drug",
        "missing_drug_id" => "Missing drug ID",
        "drug_not_found" => "Drug not found",
        "edit_drug_heading" => "Edit Drug: %s",
        "edit_location_title" => "Edit Location",
        "missing_location_id" => "Missing location ID",
        "location_not_found" => "Location not found",
        "edit_location_heading" => "Edit Location: %s",
        "language_zh" => "中文",
        "language_en" => "English",
        "login_error" => "Invalid username or password.",
    ],
];

function t($key)
{
    global $TRANSLATIONS;
    $lang = current_lang();
    return $TRANSLATIONS[$lang][$key]
        ?? $TRANSLATIONS["zh"][$key]
        ?? $key;
}
?>
